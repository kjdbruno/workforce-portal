import{r as n,O as re,S as ie,T as y,U as p,Y as r,a3 as ce,a4 as I,Z as u,w as le,a2 as de,a1 as pe,aq as ue,_ as P}from"./index-BB7BcdYj.js";import{_ as me,u as fe,b as ge,Q as ve,a as U}from"./_plugin-vue_export-helper-BBJrC21M.js";import{api as he}from"./axios-BI-bIKOT.js";import{T as g}from"./sweetalert-CFUHsfvP.js";import{n as v,S as ye,d as $}from"./simple-vue-camera.umd-DcZ6CKWX.js";const we={class:"absolute-full flex flex-center camera-overlay"},xe={key:0,class:"text-center"},_e={key:1,class:"text-center"},be={__name:"BiometricPage",setup(Se){const B=fe(),i=n(!1),c=n(!1),m=n(null);async function C(){const e="/models";await v.ssdMobilenetv1.loadFromUri(e),await v.faceLandmark68Net.loadFromUri(e),await v.faceRecognitionNet.loadFromUri(e),await v.faceExpressionNet.loadFromUri(e)}async function w(){if(!m.value)return null;try{const e=await m.value.snapshot();return await z(e)}catch(e){return console.error("Error capturing snapshot:",e),null}}function z(e){return new Promise((t,a)=>{const o=new Image;o.onload=()=>t(o),o.onerror=a,o.src=URL.createObjectURL(e)})}async function A(){const e=await w();if(!e)return null;const t=await $(e).withFaceLandmarks().withFaceDescriptor();return t?{descriptor:t.descriptor,img:e}:null}const N=e=>{const t=Array.isArray(e)?e:e?.errors||[];Object.keys(Errors).forEach(a=>{Errors[a].type=null,Errors[a].messages=[]}),t.forEach(a=>{Errors[a.path]!==void 0&&(Errors[a.path].type=!0,Errors[a.path].messages.push(a.msg))})};async function x(e){const t=e instanceof ArrayBuffer?e:e instanceof Blob?await e.arrayBuffer():new TextEncoder().encode(String(e)).buffer,a=await crypto.subtle.digest("SHA-256",t);return[...new Uint8Array(a)].map(o=>o.toString(16).padStart(2,"0")).join("")}function T(){const e="device_id";let t=localStorage.getItem(e);return t||(t=crypto.randomUUID(),localStorage.setItem(e,t)),t}async function H(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(a=>a.kind==="videoinput");return t[0]?.label||t[0]?.deviceId||"unknown-camera"}catch{return"unknown-camera"}}const O=n([]),M=n(!1),Q=async()=>{c.value=!0;try{const{passed:e,happy:t}=await j(6e3,.7);if(!e){g.fire({icon:"error",html:`
                    <div class="text-subtitle1 text-bold text-uppercase">Liveness check failed!</div>
                    <div class="text-caption text-capitalize;">Please smile clearly to continue<div>
                `});return}const a=await A(),o=await m.value.snapshot(),l=await x(o),d=T(),f=await H(),k=_.value,F=b.value,L=Array.from(a.descriptor),G={employee_id:B?.employee?.id||null,descriptor:L,geo_lat:k,geo_lng:F,camera_id:f,device_id:d,image_hash:l,captured_at:new Date().toISOString(),source:"Web"},Y=await x(JSON.stringify(G)),s=new FormData;s.append("descriptor",JSON.stringify(L)),s.append("geo_lat",k??""),s.append("geo_lng",F??""),s.append("camera_id",f),s.append("device_id",d),s.append("image_hash",l),s.append("payload_hash",Y),s.append("source","Web"),s.append("captured_at",new Date().toISOString()),s.append("file",o,`capture-${Date.now()}.jpg`);const Z=await he.post("/portal/biometric",s,{headers:{"Content-Type":"multipart/form-data"}}),{match:K,employee:h,log:X,distance:ee,liveness_passed:te}=Z.data,ae=Math.max(0,Math.min(1,1-Number(ee||0)));if(!K)g.fire({icon:"error",html:`
                    <div class="text-subtitle1 text-bold text-uppercase">not recognized!</div>
                    <div class="text-caption text-capitalize;">no matching employee found<div>
                `});else{const oe=`${h.first_name} ${h.middle_name??""} ${h.last_name}`.toUpperCase(),E=new Date(`${X.captured_at}`),se=E.toLocaleDateString("en-PH",{year:"numeric",month:"long",day:"numeric"}),ne=E.toLocaleTimeString("en-PH",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0});g.fire({icon:"success",html:`
                    <div class="text-subtitle1 text-bold text-uppercase">log recorded!</div>
                    <div class="text-body1 text-capitalize;">${oe}<div>
                    <div class="text-caption text-capitalize;">${se} @ ${ne}<div>
                    <div class="text-caption text-capitalize;">Score: ${ae.toFixed(4)} | Liveness: ${te?"Passed":"Failed"}<div>
                `})}emit("update:modelValue",null)}catch(e){e.response&&e.response.data&&(N(e.response.data),g.fire({icon:"error",html:`
                    <div class="text-h6 text-bold text-uppercase">Request Failed</div>
                    <div class="text-caption">Something went wrong.</div>
                `}))}finally{c.value=!1}},j=async(e=5e3,t=.7)=>{const a=Date.now();for(;Date.now()-a<e;){const o=await w();if(!o)continue;const l=await $(o).withFaceLandmarks().withFaceExpressions();if(!l)continue;const d=l.expressions?.happy||0;if(d>=t)return{passed:!0,happy:d};await new Promise(f=>setTimeout(f,200))}return{passed:!1,happy:0}};re(()=>{q()});const q=async e=>{await C(),O.value=[],M.value=!1,R()},_=n(null),b=n(null),S=n(null),D=n(null),R=async()=>{if(!navigator.geolocation){D.value="Geolocation not supported";return}navigator.geolocation.getCurrentPosition(async e=>{_.value=e.coords.latitude,b.value=e.coords.longitude,await V(e.coords.latitude,e.coords.longitude)},e=>{D.value=e.message},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},V=async(e,t)=>{try{const o=await(await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${e}&lon=${t}`)).json();S.value=o.display_name||"Unknown location"}catch{S.value="Unable to fetch location name"}},J=()=>{i.value=!0},W=()=>{i.value=!1};return(e,t)=>(y(),ie(ge,{class:"flex flex-center"},{default:p(()=>[r(ce,{class:"radius-md no-shadow q-pa-lg",style:{width:"65%","box-shadow":"rgba(0, 0, 0, 0.09) 0px 3px 12px"}},{default:p(()=>[r(I,{class:"text-center"},{default:p(()=>t[2]||(t[2]=[u("div",{class:"text-h6 text-uppercase"},"scan to time in/time out",-1),u("div",{class:"text-caption"},"Please position your face within the camera frame and smile clearly.",-1)])),_:1,__:[2]}),r(I,{class:"relative-position"},{default:p(()=>[r(de(ye),{ref_key:"camera",ref:m,onLoading:t[0]||(t[0]=a=>J()),onStarted:t[1]||(t[1]=a=>W()),class:"full-width"},null,512),le(u("div",we,[r(pe,{label:"Scan Face",color:"primary",unelevated:"",size:"lg",icon:"bi-camera2",class:"text-capitalize btn-xl",onClick:Q,loading:c.value},null,8,["loading"])],512),[[ue,!c.value&&!i.value]])]),_:1}),r(ve,{showing:c.value||i.value},{default:p(()=>[i.value?(y(),P("div",xe,[r(U,{size:"xl",color:"primary"}),t[3]||(t[3]=u("div",{class:"text-h6 text-dark text-uppercase q-mt-xs"},"initializing camera!",-1))])):(y(),P("div",_e,[r(U,{size:"xl",color:"primary"}),t[4]||(t[4]=u("div",{class:"text-h6 text-dark text-uppercase q-mt-xs"},"we're working on it!",-1))]))]),_:1},8,["showing"])]),_:1})]),_:1}))}},Ie=me(be,[["__scopeId","data-v-1e3eaf1e"]]);export{Ie as default};
